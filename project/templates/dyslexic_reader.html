<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dyslexic-Friendly Reader – Udaan</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    /* Local enhancements specific to the reader */
    .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:16px; }
    .toolbar label { font-weight:600; margin-right:6px; }
    .toolbar .control-group { display:flex; align-items:center; gap:8px; padding:8px 10px; background: rgba(255,255,255,0.7); border-radius:10px; }
    .reader-shell { position:relative; border-radius:16px; overflow:hidden; }
    .overlay { position:absolute; inset:0; pointer-events:none; opacity:0.25; background:#e3f6ff; transition:background 0.2s, opacity 0.2s; }
    .reader { position:relative; z-index:1; padding:28px; background:rgba(255,255,255,0.9); border-radius:16px; line-height:1.6; white-space:pre-wrap; }
    .tts-controls { display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    .badge-small { font-size: 0.85rem; padding: 2px 8px; border-radius: 8px; background: #eef6ff; color:#2563eb; }
  </style>
</head>
<body>
  <section class="glass-panel fade-in dyslexic-mode" style="max-width:900px;margin:32px auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <h2 style="margin:0;">Accessible Reading</h2>
      <a href="{{ url_for('student_dashboard') }}" class="badge">⬅ Back to Dashboard</a>
    </div>

    <div class="toolbar" role="region" aria-label="Reading preferences">
      <div class="control-group">
        <label for="fontSelect">Font</label>
        <select id="fontSelect" aria-label="Font" onchange="applyTypography()">
          <option value="OpenDyslexic, Arial, sans-serif">OpenDyslexic</option>
          <option value="Arial, sans-serif">Arial</option>
          <option value="Verdana, sans-serif">Verdana</option>
          <option value="'Segoe UI', Arial, sans-serif">Segoe UI</option>
        </select>
      </div>
      <div class="control-group">
        <label for="fontSize">Size</label>
        <input id="fontSize" type="range" min="16" max="28" step="1" value="18" oninput="applyTypography()" aria-label="Font size">
        <span id="fontSizeVal" class="badge-small">18px</span>
      </div>
      <div class="control-group">
        <label for="lineHeight">Line</label>
        <input id="lineHeight" type="range" min="1.2" max="2.5" step="0.1" value="1.6" oninput="applyTypography()" aria-label="Line spacing">
        <span id="lineHeightVal" class="badge-small">1.6</span>
      </div>
      <div class="control-group">
        <label for="wordSpacing">Word</label>
        <input id="wordSpacing" type="range" min="0" max="0.6" step="0.05" value="0.2" oninput="applyTypography()" aria-label="Word spacing">
        <span id="wordSpacingVal" class="badge-small">0.2em</span>
      </div>
      <div class="control-group">
        <label for="letterSpacing">Letter</label>
        <input id="letterSpacing" type="range" min="0" max="0.15" step="0.01" value="0.04" oninput="applyTypography()" aria-label="Letter spacing">
        <span id="letterSpacingVal" class="badge-small">0.04em</span>
      </div>
      <div class="control-group">
        <label for="overlayColor">Overlay</label>
        <input id="overlayColor" type="color" value="#e3f6ff" onchange="applyOverlay()" aria-label="Color overlay">
        <label for="overlayOpacity">Opacity</label>
        <input id="overlayOpacity" type="range" min="0" max="0.6" step="0.05" value="0.25" oninput="applyOverlay()" aria-label="Overlay opacity">
      </div>
    </div>

    <div class="reader-shell">
      <div id="overlay" class="overlay" aria-hidden="true"></div>
      <div id="readerContent" class="reader" tabindex="0">{{ text }}</div>
    </div>

    <div class="tts-controls" role="region" aria-label="Text to speech controls">
      <button class="button" onclick="ttsPlay()">▶ Play</button>
      <button class="button" onclick="ttsPause()">⏸ Pause</button>
      <button class="button" onclick="ttsStop()">⏹ Stop</button>
      <span class="badge-small" id="ttsStatus" aria-live="polite">Ready</span>
      <div class="control-group" style="margin-left:auto;">
        <label for="ttsRate">Rate</label>
        <input id="ttsRate" type="range" min="0.6" max="1.4" step="0.1" value="1" oninput="updateSpeechParams()">
        <label for="ttsPitch">Pitch</label>
        <input id="ttsPitch" type="range" min="0.6" max="1.4" step="0.1" value="1" oninput="updateSpeechParams()">
      </div>
    </div>
  </section>

  <script>
    const reader = document.getElementById('readerContent');
    const overlay = document.getElementById('overlay');

    function applyTypography(){
      const font = document.getElementById('fontSelect').value;
      const size = document.getElementById('fontSize').value;
      const line = document.getElementById('lineHeight').value;
      const word = document.getElementById('wordSpacing').value;
      const letter = document.getElementById('letterSpacing').value;

      reader.style.fontFamily = font;
      reader.style.fontSize = size + 'px';
      reader.style.lineHeight = line;
      reader.style.wordSpacing = word + 'em';
      reader.style.letterSpacing = letter + 'em';

      document.getElementById('fontSizeVal').textContent = size + 'px';
      document.getElementById('lineHeightVal').textContent = line;
      document.getElementById('wordSpacingVal').textContent = word + 'em';
      document.getElementById('letterSpacingVal').textContent = letter + 'em';
    }

    function applyOverlay(){
      const color = document.getElementById('overlayColor').value;
      const opacity = document.getElementById('overlayOpacity').value;
      overlay.style.background = color;
      overlay.style.opacity = opacity;
    }

    // Initialize defaults
    applyTypography();
    applyOverlay();

    // ---------- TTS (Web Speech API) ----------
    let utterance = null;
    function getText(){ return reader.textContent || ''; }

    function ensureUtterance(){
      if(!utterance){ utterance = new SpeechSynthesisUtterance(getText()); }
      utterance.text = getText();
      utterance.rate = parseFloat(document.getElementById('ttsRate').value);
      utterance.pitch = parseFloat(document.getElementById('ttsPitch').value);
      utterance.onstart = () => setTtsStatus('Speaking');
      utterance.onend = () => setTtsStatus('Finished');
      utterance.onerror = () => setTtsStatus('Error');
    }

    function setTtsStatus(msg){
      const el = document.getElementById('ttsStatus');
      el.textContent = msg;
    }

    function ttsPlay(){
      if(!('speechSynthesis' in window)){
        setTtsStatus('TTS not supported');
        return;
      }
      window.speechSynthesis.cancel();
      ensureUtterance();
      window.speechSynthesis.speak(utterance);
    }

    function ttsPause(){
      if(window.speechSynthesis.speaking){ window.speechSynthesis.pause(); setTtsStatus('Paused'); }
    }

    function ttsStop(){
      if(window.speechSynthesis.speaking){ window.speechSynthesis.cancel(); setTtsStatus('Stopped'); }
    }

    function updateSpeechParams(){
      if(utterance){
        utterance.rate = parseFloat(document.getElementById('ttsRate').value);
        utterance.pitch = parseFloat(document.getElementById('ttsPitch').value);
        if(window.speechSynthesis.speaking && !window.speechSynthesis.paused){
          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(utterance);
        }
      }
    }
  </script>
</body>
</html>
