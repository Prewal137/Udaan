<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  :root{
    --indigo:#4f46e5;
    --fuchsia:#d946ef;
    --sky:#0ea5e9;
    --emerald:#10b981;
  }
  body{background: linear-gradient(180deg,#f8fbff 0%, #ffffff 40%);}  
  .page-title{font-weight:800; letter-spacing:.3px;}
  .kpi{display:flex; align-items:center; gap:.5rem; background:linear-gradient(90deg, rgba(79,70,229,.12), rgba(217,70,239,.10)); border:1px solid rgba(79,70,229,.18); color:#1e293b; padding:.5rem .75rem; border-radius:12px; font-weight:700;}
  .kpi .value{font-size:1.05rem; color:#111827}
  .student-card{border:1px solid #e5e7eb; border-radius:16px; box-shadow: 0 12px 34px rgba(2,6,23,.06); overflow:hidden; transition: transform .18s ease, box-shadow .18s ease;}
  .student-card:hover{transform: translateY(-2px); box-shadow: 0 18px 44px rgba(2,6,23,.12);} 
  .student-head{background: linear-gradient(90deg, var(--indigo), var(--sky)); color:#fff; padding:.9rem 1rem; border:0;}
  .student-head a{color:#fff!important; text-decoration:none; display:block;}
  .pill{display:inline-flex; align-items:center; gap:.35rem; padding:.35rem .65rem; border-radius:999px; background:rgba(255,255,255,.16); font-weight:700;}
  .section-title{font-weight:800; color:#0f172a;}
  .list-group-item{border:0; border-bottom:1px dashed #e5e7eb;}
  .list-group-item:last-child{border-bottom:0;}
  .progress{height:.65rem; background:#eef2ff;}
  .progress-bar{border-radius:999px;}
  .badge-soft{background: rgba(16,185,129,.12); color:#065f46; border:1px solid rgba(16,185,129,.2)}
  .badge-soft-info{background: rgba(14,165,233,.12); color:#0c4a6e; border:1px solid rgba(14,165,233,.2)}
  .badge-soft-fuchsia{background: rgba(217,70,239,.12); color:#701a75; border:1px solid rgba(217,70,239,.2)}

  /* circular KPI rings */
  .ring-grid{display:grid; grid-template-columns: repeat(3, minmax(120px, 1fr)); gap:18px; margin:14px 0 6px 0;}
  .ring{position:relative; width:120px; aspect-ratio:1/1; border-radius:50%; background:
      conic-gradient(var(--ring-color) calc(var(--p)*1%), #eef2ff 0);
    display:grid; place-items:center; margin:auto;}
  .ring::after{content:""; position:absolute; inset:12px; background:#fff; border-radius:50%;}
  .ring .label{position:relative; z-index:1; font-weight:800; color:#0f172a;}
  .ring .sub{position:relative; z-index:1; font-size:.75rem; color:#64748b; margin-top:-6px;}
  .ring-card{border:1px solid #e5e7eb; border-radius:14px; padding:10px; text-align:center;}
</style>

<div class="container my-5">
  <h1 class="mb-2 text-center page-title">üìä Student Progress Dashboard</h1>
  <p class="text-center text-muted mb-4">Live overview of uploads, flashcards and quiz performance</p>

  <div class="d-flex flex-wrap gap-2 justify-content-center mb-4">
    <div class="kpi"><span>üë• Students</span><span class="value">{{ progress_data|length }}</span></div>
    <div class="kpi"><span>üìö Total Uploads</span><span class="value">{{ progress_data|sum(attribute='total_uploads') }}</span></div>
    <div class="kpi"><span>üÉè Total Flashcards</span><span class="value">{{ progress_data|sum(attribute='total_flashcards') }}</span></div>
  </div>

  {% for p in progress_data %}
  <div class="student-card mb-4">
    <div class="student-head">
      <h4 class="mb-0 d-flex align-items-center justify-content-between">
        <a data-bs-toggle="collapse" href="#student{{ loop.index }}" role="button" aria-expanded="false" aria-controls="student{{ loop.index }}">
          {{ p.student.name }}
          <span class="pill ms-2">Grade: {{ p.student.grade or '-' }}</span>
        </a>
        <span class="pill">Avg: {{ p.avg_score }}%</span>
      </h4>
    </div>

    <div class="collapse" id="student{{ loop.index }}">
      <div class="card-body">
        <!-- Visual KPI rings -->
        <div class="ring-grid">
          <div class="ring-card">
            <div class="ring" style="--p: {{ (p.total_uploads/10*100)|round(1) }}; --ring-color: var(--emerald);">
              <div class="label">{{ (p.total_uploads/10*100)|round(0) }}%</div>
              <div class="sub">Uploads</div>
            </div>
          </div>
          <div class="ring-card">
            <div class="ring" style="--p: {{ (p.total_flashcards/20*100)|round(1) }}; --ring-color: var(--sky);">
              <div class="label">{{ p.total_flashcards }}</div>
              <div class="sub">Flashcards</div>
            </div>
          </div>
          <div class="ring-card">
            <div class="ring" style="--p: {{ (p.avg_score)|round(1) }}; --ring-color: var(--fuchsia);">
              <div class="label">{{ p.avg_score }}%</div>
              <div class="sub">Avg Score</div>
            </div>
          </div>
        </div>

        <div class="row g-4 mt-1">
          <!-- Textbooks -->
          <div class="col-md-4">
            <h6 class="section-title mb-2">üìö Textbooks Uploaded <span class="badge badge-soft ms-1">{{ p.total_uploads }}</span></h6>
            <ul class="list-group list-group-flush mb-2">
              {% for u in p.uploads %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span class="text-truncate" style="max-width:70%">{{ u.filename }}</span>
                <small class="text-muted">{{ u.uploaded_at }}</small>
              </li>
              {% endfor %}
              {% if p.uploads|length == 0 %}
              <li class="list-group-item text-muted">No textbooks uploaded</li>
              {% endif %}
            </ul>
            <div class="progress" title="Uploads">
              <div class="progress-bar bg-success" role="progressbar" style="width: {{ (p.total_uploads/10)*100 }}%" aria-valuenow="{{ p.total_uploads }}" aria-valuemin="0" aria-valuemax="10"></div>
            </div>
          </div>

          <!-- Flashcards -->
          <div class="col-md-4">
            <h6 class="section-title mb-2">üÉè Flashcards Generated <span class="badge badge-soft-info ms-1">{{ p.total_flashcards }}</span></h6>
            <ul class="list-group list-group-flush mb-2">
              {% for f in p.flashcards %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span class="text-truncate" style="max-width:70%">{{ f.filename }}</span>
                <span class="badge bg-secondary">{{ f.num_flashcards }} cards</span>
              </li>
              {% endfor %}
              {% if p.flashcards|length == 0 %}
              <li class="list-group-item text-muted">No flashcards generated</li>
              {% endif %}
            </ul>
            <div class="progress" title="Flashcards">
              <div class="progress-bar bg-info" role="progressbar" style="width: {{ (p.total_flashcards/20)*100 }}%" aria-valuenow="{{ p.total_flashcards }}" aria-valuemin="0" aria-valuemax="20"></div>
            </div>
          </div>

          <!-- Quizzes -->
          <div class="col-md-4">
            <h6 class="section-title mb-2">üß† Quizzes & Scores <span class="badge badge-soft-fuchsia ms-1">{{ p.total_quizzes }}</span></h6>
            <div class="d-flex align-items-center gap-2 mb-2">
              <span class="badge bg-success">Avg Score: {{ p.avg_score }}%</span>
              <span class="badge bg-primary">Attempts: {{ p.total_quizzes }}</span>
            </div>
            <div class="small text-muted mb-1">Completion: {{ p.completion_rate }}</div>
            <div class="progress" title="Quizzes">
              <div class="progress-bar" style="background:linear-gradient(90deg,var(--fuchsia),var(--indigo)); width: {{ (p.total_quizzes/10)*100 }}%"></div>
            </div>
            {% if p.num_audiobooks %}
            <div class="mt-3 small text-muted">üéß Audiobooks generated: {{ p.num_audiobooks }}</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


